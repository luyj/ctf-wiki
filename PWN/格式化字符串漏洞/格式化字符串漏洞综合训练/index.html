



<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="jp">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../../../favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-4.6.3">
    
    
      
        <title>格式化字符串漏洞综合训练 - CUC CTF-Wiki</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,400,400i,700%7CFira+Mono&display=fallback">
        <style>body,input{font-family:"Fira Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Fira Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
      <link rel="manifest" type="application/manifest+json" href="../../../manifest.webmanifest" crossorigin="use-credentials">
    
    
      <link rel="stylesheet" href="../../../_static/css/extra.css?v=12">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#_1" tabindex="0" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="CUC CTF-Wiki" aria-label="CUC CTF-Wiki" class="md-header-nav__button md-logo">
          
            <i class="md-icon">school</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              CUC CTF-Wiki
            </span>
            <span class="md-header-nav__topic">
              
                格式化字符串漏洞综合训练
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../.." class="md-tabs__link">
          首页
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../MISC/intro/" class="md-tabs__link">
          MISC
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../CRYPRO/intro/" class="md-tabs__link">
          CRYPRO
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../WEB/intro/" class="md-tabs__link">
          WEB
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../intro/" class="md-tabs__link">
          PWN
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../REVERSE/intro/" class="md-tabs__link">
          REVERSE
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../training/2020Autumn/2020AutumnOutline/" class="md-tabs__link">
          集训安排
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../.." title="CUC CTF-Wiki" class="md-nav__button md-logo">
      
        <i class="md-icon">school</i>
      
    </a>
    CUC CTF-Wiki
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      首页
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        首页
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../.." title="主页" class="md-nav__link">
      主页
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../intro/" title="关于本项目" class="md-nav__link">
      关于本项目
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../FAQ/" title="F.A.Q" class="md-nav__link">
      F.A.Q
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      MISC
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        MISC
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../MISC/intro/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../MISC/MISC-2/MISC-2/" title="信息搜集 && 编码" class="md-nav__link">
      信息搜集 && 编码
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../MISC/MISC-1/%E6%95%B0%E5%AD%97%E5%8F%96%E8%AF%81_%E9%9A%90%E5%86%99%E5%88%86%E6%9E%90/" title="数字取证 && 隐写分析" class="md-nav__link">
      数字取证 && 隐写分析
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      CRYPRO
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        CRYPRO
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../CRYPRO/intro/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../CRYPRO/%E7%AC%AC%E4%B8%89%E5%91%A8-Crypto/Crypto/" title="古典密码、对称加密、非对称加密" class="md-nav__link">
      古典密码、对称加密、非对称加密
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      WEB
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        WEB
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../WEB/intro/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../WEB/WEB-1/XSS%28%E8%B7%A8%E7%AB%99%E7%82%B9%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BB%29/" title="XSS" class="md-nav__link">
      XSS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../WEB/WEB-2/Web%20PHP%20audit/" title="PHP audit" class="md-nav__link">
      PHP audit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../WEB/WEB-3/" title="SQL Injection" class="md-nav__link">
      SQL Injection
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      PWN
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        PWN
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../intro/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      REVERSE
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        REVERSE
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../REVERSE/intro/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      集训安排
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        集训安排
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../training/2020Autumn/2020AutumnOutline/" title="2020秋季集训" class="md-nav__link">
      2020秋季集训
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <style>
section {
  font-family: 'Microsoft YaHei', 'SimHei', sans-serif;
  font-size: 30px;
}
</style>

<h1 id="_1">格式化字符串漏洞<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<hr />
<h1 id="_2">目录<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h1>
<ul>
<li>1 格式化字符串漏洞原理</li>
<li>1.1 格式化字符串函数介绍<ul>
<li>1.1.1 格式化字符串函数</li>
<li>1.1.2 格式化字符串 </li>
<li>1.1.3 参数</li>
</ul>
</li>
<li>1.2 漏洞成因</li>
<li>1.3 格式化字符串漏洞利用<ul>
<li>1.3.1 使程序崩溃</li>
<li>1.3.2 查看栈内容</li>
<li>1.3.3 查看任意地址内容</li>
</ul>
</li>
<li>2 格式化字符串漏洞练习题</li>
</ul>
<hr />
<h1 id="1">1 格式化字符串漏洞原理<a class="headerlink" href="#1" title="Permanent link">&para;</a></h1>
<hr />
<h1 id="11">1.1 格式化字符串函数介绍<a class="headerlink" href="#11" title="Permanent link">&para;</a></h1>
<p>格式化字符串函数可以接受<strong>可变数量的参数</strong>，并将<strong>第一个参数作为格式化字符串，根据其来解析之后的参数</strong>。</p>
<p>通俗来说，<strong>格式化字符串函数就是将计算机内存中表示的数据转化为我们人类可读的字符串格式</strong>。</p>
<p>几乎所有的 C/C++ 程序都会利用格式化字符串函数来<strong>输出信息</strong>，<strong>调试程序</strong>，或者<strong>处理字符串</strong>。</p>
<hr />
<p>一般来说，格式化字符串在利用的时候主要分为三个部分：<strong>格式化字符串函数 、格式化字符串 、后续参数(可选)</strong></p>
<p><strong>举个栗子</strong></p>
<p><center><img src="./img/printf_example.jpg" width="1000"></center></p>
<!-- 

此处的格式化字符串调用例子中
格式化字符串函数为 printf
格式化字符串为 " Welcode to  %d %s "
其余参数为可选参数

 -->

<hr />
<h1 id="111">1.1.1 格式化字符串函数<a class="headerlink" href="#111" title="Permanent link">&para;</a></h1>
<p><strong>输入函数</strong>
  - scanf</p>
<p><strong>输出函数</strong></p>
<table>
<thead>
<tr>
<th>函数</th>
<th>基本介绍</th>
</tr>
</thead>
<tbody>
<tr>
<td>printf</td>
<td>输出到 stdout</td>
</tr>
<tr>
<td>fprintf</td>
<td>输出到指定 FILE 流</td>
</tr>
<tr>
<td>syslog</td>
<td>输出日志</td>
</tr>
</tbody>
</table>
<hr />
<h1 id="112">1.1.2 格式化字符串<a class="headerlink" href="#112" title="Permanent link">&para;</a></h1>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="p">[</span><span class="n">parameter</span><span class="p">][</span><span class="n">flags</span><span class="p">][</span><span class="n">field</span> <span class="n">width</span><span class="p">][.</span><span class="n">precision</span><span class="p">][</span><span class="n">length</span><span class="p">]</span><span class="n">type</span>
</code></pre></div>
</td></tr></table>
<p><strong>type</strong></p>
<!-- 需要重点关注的 -->

<ul>
<li>d/i，有符号整数</li>
<li>u，无符号整数</li>
<li>x/X，16 进制 unsigned int 。x 使用小写字母；X 使用大写字母。</li>
<li>n，不输出字符，但是把已经<strong>成功输出</strong>的字符个数写入对应的整型指针参数所指的变量。</li>
</ul>
<hr />
<h1 id="113">1.1.3 参数<a class="headerlink" href="#113" title="Permanent link">&para;</a></h1>
<p>就是相应的要输出的变量</p>
<!-- ---

我们再继续以上面的为例子进行介绍,对于上面的例子，在进入 printf 函数的之前 (即还没有调用 printf)，栈上的布局由高地址到低地址依次如下

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="n">some</span> <span class="n">value</span>
<span class="n">CUC</span> <span class="n">CTF</span> 
<span class="mi">2020</span>
<span class="n">addr</span> <span class="n">of</span> <span class="n">format</span> <span class="nl">string</span><span class="p">:</span> <span class="n">Welcode</span> <span class="n">to</span>  <span class="o">%</span><span class="n">d</span> <span class="o">%</span><span class="n">s</span>

<span class="err">```</span> <span class="o">--&gt;</span>

<span class="o">---</span>

<span class="cp"># 1.2 漏洞成因</span>
<span class="o">---</span>

<span class="o">&lt;</span><span class="n">center</span><span class="o">&gt;&lt;</span><span class="n">span</span><span class="o">&gt;</span><span class="n">printf</span> <span class="err">格式化字符串函数执行流图</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;/</span><span class="n">center</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">center</span><span class="o">&gt;&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s">&quot;./img/流程图.jpg&quot;</span> <span class="o">&gt;&lt;/</span><span class="n">center</span><span class="o">&gt;</span>

<span class="o">---</span>

<span class="err">那么假设，此时我们在编写程序时候，写成了如下形式：</span>

<span class="err">```</span><span class="n">python</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Welcode to  %d %s&quot;</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
</br>
<!-- 此时我们可以发现我们并没有提供参数，那么程序会如何运行呢？程序照样会运行，会将栈上存储格式化字符串地址上面的 2 个变量分别解析为
解析其内容对应的整形值
解析其地址对应的字符串
-->

<!-- 对于 1 来说倒还无妨，但是对于对于 2 来说，如果提供了一个不可访问地址，比如 0，那么程序就会因此而崩溃。 -->

<p>执行输出结果:</p>
<p><center><img src="./img/printf_exploit_test.PNG" ></center></p>
<p></br></p>
<p>漏洞原因：格式字符串<strong>要求的参数</strong>和<strong>实际提供的参数</strong>不匹配</p>
<hr />
<p><strong>为什么可以通过编译？</strong>
- 因为 printf() 函数的参数被定义为<strong>可变</strong>的。</p>
<ul>
<li>
<p>为了发现不匹配的情况，编译器需要理解 printf() 是怎么工作的和格式字符串是什么。然而，编译器并不知道这些。</p>
</li>
<li>
<p>有时格式字符串并不是固定的，它可能在程序执行中<strong>动态生成</strong>。</p>
</li>
</ul>
<hr />
<p><strong>printf() 函数自己可以发现不匹配吗？</strong></p>
<p>printf() 函数从栈中取出参数，如果它需要 3 个，那它就取出 3 个。除非栈的边界被标记了，否则 printf() 是不会知道它取出的参数比提供给它的参数多了。然而并没有这样的标记。</p>
<hr />
<h1 id="13">1.3 格式化字符串漏洞利用<a class="headerlink" href="#13" title="Permanent link">&para;</a></h1>
<hr />
<p>实验环境</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>ubuntu <span class="m">16</span>.04
gdb  <span class="m">7</span>.8
gcc <span class="m">5</span>.4.0
</code></pre></div>
</td></tr></table>
<hr />
<p>例如，我们给定如下程序</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mh">0x22222222</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">-1</span><span class="p">;</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%08x.%08x.%08x.%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
编译</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ gcc -m32 -fno-stack-protector -no-pie -o leakmemory leakmemory.c
</code></pre></div>
</td></tr></table>
<hr />
<h3 id="131">1.3.1 使程序崩溃<a class="headerlink" href="#131" title="Permanent link">&para;</a></h3>
<p>崩溃原因是因为栈上不可能每个值都对应了合法的地址，所以总是会有某个地址可以使得程序崩溃（地址越界访问）。</p>
<p><center><img src="./img/格式化字符串崩溃.PNG" ></center></p>
<hr />
<h3 id="132">1.3.2 查看栈内容<a class="headerlink" href="#132" title="Permanent link">&para;</a></h3>
<p>首先测试一下执行效果：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ ./leakmemory

%08x.%08x.%08x
</code></pre></div>
</td></tr></table>
<p>执行结果
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>./leakmemory
%08x.%08x.%08x
<span class="m">00000001</span>.22222222.ffffffff.%08x.%08x.%08x
ffbbe980.000000c2.f7e4c79b
</code></pre></div>
</td></tr></table></p>
<!-- <center><img src="./img/leak_memory_1.PNG" ></center> -->

<hr />
<p>为了更加细致的观察,使用 GDB 调试。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="c1">#使用 gdb 进行调试</span>
<span class="nv">$gdb</span> leakmemory
<span class="c1"># 下断点</span>
gdb-peda$ b <span class="nb">printf</span>
    Breakpoint <span class="m">1</span> at 0x8048330
<span class="c1">#开始执行程序</span>
gdb-peda$ r
    Starting program: /home/giantbranch/tmp/leakmemory
    ffb4e190.000000c2.f7d8f79bgiantbranch@ubuntu:~/tmp$
</code></pre></div>
</td></tr></table>
<!-- 此时，程序等待我们的输入，这时我们输入 %08x.%08x.%08x，然后敲击回车，是程序继续运行，可以看出程序首先断在了第一次调用 printf 函数的位置 -->

<p>程序<strong>断在 printf 函数首次调用位置</strong>，查看栈空间。</p>
<hr />
<p><center><img src="./img/leak_memory_debug_1.png" ></center></p>
<!-- 可以看出，此时已经进入了 printf 函数中，栈中第一个变量为返回地址，第二个变量为格式化字符串的地址，第三个变量为 a 的值，第四个变量为 b 的值，第五个变量为 c 的值，第六个变量为我们输入的格式化字符串对应的地址。继续运行程序 -->

<hr />
<p>继续执行，程序输出每个变量对应的值。并且断在了下一个 printf 处。</p>
<!-- 此时，由于格式化字符串为 %x%x%x，所以，程序 会将栈上的 0xffffcd04 及其之后的数值分别作为第一，第二，第三个参数按照 int 型进行解析，分别输出。继续运行，我们可以得到如下结果去，确实和想象中的一样。 -->

<p><center><img src="./img/leak_memory_debug_2.PNG"  ></center></p>
<hr />
<p>继续执行，由于格式化字符串为 %x%x%x，所以，程序会将栈上的<code>0xffffd304</code>及之后的数值分别作为 1、2、3 个参数按照 int 型进行解析，分别输出。</p>
<p><center><img src="./img/leak_memory_debug_3.PNG"  ></center></p>
<hr />
<h3 id="132-n1">1.3.2 直接获取栈中被视为第 n+1 个参数的值<a class="headerlink" href="#132-n1" title="Permanent link">&para;</a></h3>
<p><code>%n$x</code></p>
<p></br>
为什么是第 n+1 个参数?</p>
<!-- 格式化参数里面的 n 指的是该格式化字符串对应的**第 n 个输出参数**，
那相对于调用函数来说，**第 1 个参数是格式化字符串，不输出** , 就是第 n+1 个参数了。 -->

<p><center><img src="./img/n+1.jpg"  ></center></p>
<hr />
<p>重新调试运行，可以看出，我们确实获得了 <strong>printf 的第 4 个参数</strong>所对应的值 f7e8979b。</p>
<p><center><img src="./img/leak_memory_debug_4.PNG"  ></center></p>
<hr />
<h3 id="133">1.3.3 查看任意内存的地址<a class="headerlink" href="#133" title="Permanent link">&para;</a></h3>
<p>原理：<strong>显示指定解析地址的内存</strong></p>
<p>例如：printf 参数存储字符串起始地址，输出 %s 时，读取参数内容并将其作为字符串起始地址,直到遇到一个空字符,读取结束。</p>
<p><center><img src="./img/string_pointer.PNG"  ></center></p>
<!-- 使用 %s 显示参数，指针所指定的地址的内存，将它作为一个 ASCII 字符串处理，直到遇到一个空字符。如果攻击者能够操纵这个参数指针指向一个特定的地址，那么 %s 就会输出该位置的内存内容。 -->

<hr />
<h3 id="1_1">(1). 获取输入参数在栈上的偏移<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>由 0x41414141 处所在的位置可以看出我们的格式化字符串的起始地址正好是输出函数的第 5 个参数，但是是格式化字符串的第 4 个参数。我们可以来测试一下</p>
<p><center><img src="./img/print_input.PNG"  ></center></p>
<h3 id="2">(2). 根据偏移查看输出内容<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>0x41414141 是输出的第 4 个字符，所以我们使用 %4$p 即可读出 0x41414141 处的内容，
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ ./leakmemory
AAAA%4<span class="nv">$p</span>
<span class="m">00000001</span>.22222222.ffffffff.AAAA%4<span class="nv">$p</span>
AAAA0x41414141
</code></pre></div>
</td></tr></table></p>
<hr />
<p>当然，这可能是一个不合法的地址。我们把 AAAA 换成我们需要的合法的地址即可查看对应地址的内容。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>python2 -c <span class="s1">&#39;print(&quot;AAA&quot; + &quot;\00\x10\xd3\xff\xff&quot;+&quot;.%5$s&quot;)&#39;</span> &gt; text
</code></pre></div>
</td></tr></table>
<p><center><img src="./img/get_address_context.PNG"  ></center></p>
<hr />
<h2 id="2_1">2 格式化字符串漏洞练习题<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://adworld.xctf.org.cn/task/answer?type=pwn&amp;number=2&amp;grade=0&amp;id=5050&amp;page=1">XCTF-攻防世界 CGfsb 格式化字符串漏洞</a></li>
<li><a href="https://adworld.xctf.org.cn/task/answer?type=pwn&amp;number=2&amp;grade=1&amp;id=4913&amp;page=1">实时数据监测</a></li>
</ul>
<hr />
<h2 id="_3">参考资料<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/fmtstr/fmtstr_exploit-zh/#_4">ctf wiki</a></li>
<li><a href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/2.3.1_gdb.html">ctf alll in one</a></li>
</ul>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.c33a9706.js"></script>
      
        
        
          
          <script src="../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
            
          
          
        
      
      <script>app.initialize({version:"1.1.2",url:{base:"../../.."}})</script>
      
        <script src="../../../_static/js/extra.js?v=16"></script>
      
        <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>